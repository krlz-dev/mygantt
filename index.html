<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SimpleGantt</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        :root {
            --primary: #4f46e5;
            --primary-light: #818cf8;
            --sidebar-width: 300px;
            --row-height: 44px;
            --header-height: 60px;
            --timeline-header: 50px;
        }

        * { box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #f8fafc;
            overflow: hidden;
        }

        /* Header */
        .app-header {
            height: var(--header-height);
            background: white;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            padding: 0 20px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
        }

        .app-header h1 {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary);
            margin: 0;
        }

        .app-header .btn-add {
            background: var(--primary);
            border: none;
            padding: 8px 16px;
            font-size: 0.875rem;
        }

        .app-header .btn-add:hover {
            background: var(--primary-light);
        }

        /* Main Container */
        .gantt-container {
            display: flex;
            margin-top: var(--header-height);
            height: calc(100vh - var(--header-height));
        }

        /* Task Sidebar */
        .task-sidebar {
            width: var(--sidebar-width);
            min-width: var(--sidebar-width);
            background: white;
            border-right: 2px solid #e2e8f0;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            height: var(--timeline-header);
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            padding: 0 16px;
            font-weight: 600;
            color: #64748b;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .task-list { flex: 1; overflow-y: auto; }

        .task-row {
            height: var(--row-height);
            display: flex;
            align-items: center;
            padding: 0 8px 0 16px;
            border-bottom: 1px solid #f1f5f9;
            cursor: pointer;
            transition: background 0.15s;
        }

        .task-row:hover { background: #f8fafc; }
        .task-row.group { background: #f1f5f9; font-weight: 600; }

        .task-row .task-icon {
            width: 20px;
            margin-right: 8px;
            color: #94a3b8;
        }

        .task-row .task-name {
            flex: 1;
            font-size: 0.875rem;
            color: #1e293b;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .task-row .task-actions {
            display: none;
            gap: 4px;
        }

        .task-row:hover .task-actions { display: flex; }
        .task-row:hover .task-assignee { display: none; }

        .task-row .task-actions .btn {
            padding: 2px 6px;
            font-size: 0.75rem;
        }

        .task-row .task-assignee {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--primary-light);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 600;
        }

        /* Timeline Area */
        .timeline-area {
            flex: 1;
            overflow-x: auto;
            overflow-y: auto;
            position: relative;
        }

        .timeline-wrapper {
            min-width: 100%;
            position: relative;
        }

        /* Timeline Header */
        .timeline-header {
            height: var(--timeline-header);
            background: white;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .timeline-month {
            text-align: center;
            border-right: 1px solid #e2e8f0;
        }

        .timeline-month-name {
            font-size: 0.75rem;
            font-weight: 600;
            color: #64748b;
            padding: 4px 0;
            border-bottom: 1px solid #f1f5f9;
        }

        .timeline-days { display: flex; }

        .timeline-day {
            width: 36px;
            min-width: 36px;
            text-align: center;
            font-size: 0.7rem;
            color: #94a3b8;
            padding: 4px 0;
        }

        .timeline-day.weekend { background: #fafafa; color: #cbd5e1; }
        .timeline-day.today { background: #eef2ff; color: var(--primary); font-weight: 600; }

        /* Timeline Body */
        .timeline-body { position: relative; }

        .timeline-row {
            height: var(--row-height);
            border-bottom: 1px solid #f1f5f9;
            position: relative;
            display: flex;
        }

        .timeline-row.group { background: #f8fafc; }

        .timeline-cell {
            width: 36px;
            min-width: 36px;
            border-right: 1px solid #f1f5f9;
        }

        .timeline-cell.weekend { background: #fafafa; }
        .timeline-cell.today { background: #eef2ff; }

        /* Gantt Bars */
        .gantt-bar {
            position: absolute;
            height: 24px;
            top: 10px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            padding: 0 8px;
            font-size: 0.75rem;
            color: white;
            font-weight: 500;
            cursor: grab;
            transition: box-shadow 0.15s;
            z-index: 5;
            user-select: none;
        }

        .gantt-bar:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .gantt-bar.dragging { cursor: grabbing; opacity: 0.8; z-index: 20; }

        .gantt-bar.blue { background: linear-gradient(135deg, #3b82f6, #2563eb); }
        .gantt-bar.green { background: linear-gradient(135deg, #22c55e, #16a34a); }
        .gantt-bar.purple { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
        .gantt-bar.orange { background: linear-gradient(135deg, #f97316, #ea580c); }
        .gantt-bar.pink { background: linear-gradient(135deg, #ec4899, #db2777); }
        .gantt-bar.teal { background: linear-gradient(135deg, #14b8a6, #0d9488); }

        .gantt-bar .progress-fill {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            background: rgba(255,255,255,0.25);
            border-radius: 4px 0 0 4px;
            pointer-events: none;
        }

        .gantt-bar .bar-label {
            position: relative;
            z-index: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            pointer-events: none;
        }

        /* Resize Handles */
        .gantt-bar .resize-handle {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 8px;
            cursor: ew-resize;
        }

        .gantt-bar .resize-handle.left { left: 0; }
        .gantt-bar .resize-handle.right { right: 0; }

        /* Group Bar */
        .gantt-bar.group-bar {
            height: 8px;
            top: 18px;
            background: #475569;
            border-radius: 2px;
            cursor: default;
        }

        .gantt-bar.group-bar::before,
        .gantt-bar.group-bar::after {
            content: '';
            position: absolute;
            bottom: -4px;
            width: 8px;
            height: 8px;
            background: #475569;
        }

        .gantt-bar.group-bar::before { left: 0; clip-path: polygon(0 0, 100% 0, 50% 100%); }
        .gantt-bar.group-bar::after { right: 0; clip-path: polygon(0 0, 100% 0, 50% 100%); }

        /* Milestone */
        .milestone {
            position: absolute;
            width: 20px;
            height: 20px;
            top: 12px;
            background: #f97316;
            transform: rotate(45deg);
            border-radius: 3px;
            cursor: pointer;
            z-index: 5;
        }

        /* Dependencies SVG */
        .dependencies-layer {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
            z-index: 4;
        }

        .dependency-line {
            fill: none;
            stroke: #94a3b8;
            stroke-width: 2;
            marker-end: url(#arrowhead);
        }

        /* Today Line */
        .today-line {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #ef4444;
            z-index: 6;
            pointer-events: none;
        }

        .today-line::before {
            content: 'Today';
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.65rem;
            color: #ef4444;
            font-weight: 600;
            white-space: nowrap;
        }

        /* Modal customizations */
        .modal-header { border-bottom: 1px solid #e2e8f0; }
        .modal-footer { border-top: 1px solid #e2e8f0; }

        .color-picker {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .color-option {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            cursor: pointer;
            border: 3px solid transparent;
            transition: transform 0.15s;
        }

        .color-option:hover { transform: scale(1.1); }
        .color-option.selected { border-color: #1e293b; }

        .color-option.blue { background: linear-gradient(135deg, #3b82f6, #2563eb); }
        .color-option.green { background: linear-gradient(135deg, #22c55e, #16a34a); }
        .color-option.purple { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
        .color-option.orange { background: linear-gradient(135deg, #f97316, #ea580c); }
        .color-option.pink { background: linear-gradient(135deg, #ec4899, #db2777); }
        .color-option.teal { background: linear-gradient(135deg, #14b8a6, #0d9488); }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Toast */
        .toast-container { z-index: 1100; }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="app-header">
        <h1><i class="bi bi-bar-chart-steps me-2"></i>SimpleGantt</h1>
        <div class="ms-auto d-flex gap-2">
            <button class="btn btn-outline-secondary btn-sm" onclick="scrollToToday()">
                <i class="bi bi-calendar3"></i> Today
            </button>
            <div class="dropdown">
                <button class="btn btn-outline-secondary btn-sm dropdown-toggle" data-bs-toggle="dropdown">
                    <i class="bi bi-gear"></i>
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                    <li><h6 class="dropdown-header">Export Image</h6></li>
                    <li><a class="dropdown-item" href="#" onclick="exportAsPNG()"><i class="bi bi-file-image me-2"></i>Export as PNG</a></li>
                    <li><a class="dropdown-item" href="#" onclick="exportAsSVG()"><i class="bi bi-filetype-svg me-2"></i>Export as SVG</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><h6 class="dropdown-header">Project Data</h6></li>
                    <li><a class="dropdown-item" href="#" onclick="exportData()"><i class="bi bi-download me-2"></i>Export JSON</a></li>
                    <li><a class="dropdown-item" href="#" onclick="document.getElementById('importFile').click()"><i class="bi bi-upload me-2"></i>Import JSON</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item text-danger" href="#" onclick="clearAllData()"><i class="bi bi-trash me-2"></i>Clear All</a></li>
                </ul>
            </div>
            <input type="file" id="importFile" accept=".json" style="display:none" onchange="importData(event)">
            <button class="btn btn-add btn-primary btn-sm text-white" onclick="openTaskModal()">
                <i class="bi bi-plus-lg me-1"></i> Add Task
            </button>
        </div>
    </header>

    <!-- Main Gantt Container -->
    <div class="gantt-container">
        <div class="task-sidebar">
            <div class="sidebar-header">
                <span>Task Name</span>
                <span class="ms-auto">Assignee</span>
            </div>
            <div class="task-list" id="taskList"></div>
        </div>

        <div class="timeline-area" id="timelineArea">
            <div class="timeline-wrapper" id="timelineWrapper">
                <div class="timeline-header" id="timelineHeader"></div>
                <div class="timeline-body" id="timelineBody">
                    <svg class="dependencies-layer" id="dependenciesLayer">
                        <defs>
                            <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                                <polygon points="0 0, 10 3.5, 0 7" fill="#94a3b8" />
                            </marker>
                        </defs>
                    </svg>
                </div>
            </div>
        </div>
    </div>

    <!-- Task Modal -->
    <div class="modal fade" id="taskModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="taskModalTitle">Add Task</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="taskId">
                    <div class="mb-3">
                        <label class="form-label">Task Name</label>
                        <input type="text" class="form-control" id="taskName" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Type</label>
                        <select class="form-select" id="taskType" onchange="toggleTaskFields()">
                            <option value="task">Task</option>
                            <option value="group">Group</option>
                            <option value="milestone">Milestone</option>
                        </select>
                    </div>
                    <div class="row mb-3" id="dateFields">
                        <div class="col">
                            <label class="form-label">Start Date</label>
                            <input type="date" class="form-control" id="taskStart">
                        </div>
                        <div class="col" id="endDateCol">
                            <label class="form-label">End Date</label>
                            <input type="date" class="form-control" id="taskEnd">
                        </div>
                    </div>
                    <div id="taskFields">
                        <div class="mb-3">
                            <label class="form-label">Assignee (initials)</label>
                            <input type="text" class="form-control" id="taskAssignee" maxlength="3" placeholder="e.g. JD">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Progress: <span id="progressValue">0</span>%</label>
                            <input type="range" class="form-range" id="taskProgress" min="0" max="100" value="0" oninput="document.getElementById('progressValue').textContent=this.value">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Color</label>
                            <div class="color-picker" id="colorPicker">
                                <div class="color-option blue selected" data-color="blue"></div>
                                <div class="color-option green" data-color="green"></div>
                                <div class="color-option purple" data-color="purple"></div>
                                <div class="color-option orange" data-color="orange"></div>
                                <div class="color-option pink" data-color="pink"></div>
                                <div class="color-option teal" data-color="teal"></div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Depends On</label>
                            <select class="form-select" id="taskDependency">
                                <option value="">None</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger me-auto" id="deleteTaskBtn" onclick="deleteTask()" style="display:none">
                        <i class="bi bi-trash"></i> Delete
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveTask()">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="toast" class="toast" role="alert">
            <div class="toast-body d-flex align-items-center">
                <span id="toastMessage"></span>
                <button type="button" class="btn-close ms-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Config
        const dayWidth = 36;
        const rowHeight = 44;
        const STORAGE_KEY = 'simplegantt_data';

        // State
        let tasks = [];
        let startDate = new Date();
        let endDate = new Date();
        let today = new Date();
        today.setHours(0, 0, 0, 0);

        // Default data
        const defaultTasks = [
            { id: 1, name: 'Project Planning', type: 'group', start: '2026-01-06', end: '2026-01-20' },
            { id: 2, name: 'Requirements gathering', start: '2026-01-06', end: '2026-01-10', color: 'blue', progress: 100, assignee: 'JD' },
            { id: 3, name: 'Technical specifications', start: '2026-01-08', end: '2026-01-14', color: 'blue', progress: 75, assignee: 'AS', dependsOn: 2 },
            { id: 4, name: 'Design approval', start: '2026-01-15', end: '2026-01-15', type: 'milestone', dependsOn: 3 },
            { id: 5, name: 'Development', type: 'group', start: '2026-01-13', end: '2026-02-07' },
            { id: 6, name: 'Frontend development', start: '2026-01-13', end: '2026-01-28', color: 'green', progress: 40, assignee: 'MK' },
            { id: 7, name: 'Backend API', start: '2026-01-15', end: '2026-01-30', color: 'purple', progress: 30, assignee: 'JD', dependsOn: 4 },
            { id: 8, name: 'Database setup', start: '2026-01-13', end: '2026-01-20', color: 'teal', progress: 60, assignee: 'AS' },
            { id: 9, name: 'Integration', start: '2026-01-28', end: '2026-02-07', color: 'orange', progress: 0, assignee: 'MK', dependsOn: 6 },
            { id: 10, name: 'Testing & Launch', type: 'group', start: '2026-02-02', end: '2026-02-20' },
            { id: 11, name: 'QA Testing', start: '2026-02-02', end: '2026-02-12', color: 'pink', progress: 0, assignee: 'QA', dependsOn: 9 },
            { id: 12, name: 'Bug fixes', start: '2026-02-10', end: '2026-02-17', color: 'orange', progress: 0, assignee: 'JD', dependsOn: 11 },
            { id: 13, name: 'Launch', start: '2026-02-20', end: '2026-02-20', type: 'milestone', dependsOn: 12 },
        ];

        // Utility functions
        function daysBetween(d1, d2) {
            return Math.round((d2 - d1) / (1000 * 60 * 60 * 24));
        }

        function formatDate(date) {
            return date.toISOString().split('T')[0];
        }

        function parseDate(str) {
            const d = new Date(str + 'T00:00:00');
            return d;
        }

        function calculateDateRange() {
            if (tasks.length === 0) {
                startDate = new Date(today);
                startDate.setDate(startDate.getDate() - 7);
                endDate = new Date(today);
                endDate.setDate(endDate.getDate() + 60);
                return;
            }

            let minDate = parseDate(tasks[0].start);
            let maxDate = parseDate(tasks[0].end);

            tasks.forEach(t => {
                const s = parseDate(t.start);
                const e = parseDate(t.end);
                if (s < minDate) minDate = s;
                if (e > maxDate) maxDate = e;
            });

            startDate = new Date(minDate);
            startDate.setDate(startDate.getDate() - 7);
            endDate = new Date(maxDate);
            endDate.setDate(endDate.getDate() + 14);
        }

        // Local Storage
        function saveToStorage() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(tasks));
        }

        function loadFromStorage() {
            const data = localStorage.getItem(STORAGE_KEY);
            if (data) {
                tasks = JSON.parse(data);
            } else {
                tasks = [...defaultTasks];
            }
        }

        // Export/Import
        function exportData() {
            const dataStr = JSON.stringify(tasks, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'gantt-project.json';
            a.click();
            URL.revokeObjectURL(url);
            showToast('Project exported successfully!');
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    tasks = JSON.parse(e.target.result);
                    saveToStorage();
                    render();
                    showToast('Project imported successfully!');
                } catch (err) {
                    showToast('Invalid JSON file!');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function clearAllData() {
            if (confirm('Are you sure you want to delete all tasks?')) {
                tasks = [];
                saveToStorage();
                render();
                showToast('All tasks cleared');
            }
        }

        // Toast
        function showToast(message) {
            document.getElementById('toastMessage').textContent = message;
            const toast = new bootstrap.Toast(document.getElementById('toast'));
            toast.show();
        }

        // Render functions
        function renderTimelineHeader() {
            const header = document.getElementById('timelineHeader');
            let html = '';
            let current = new Date(startDate);

            while (current <= endDate) {
                const month = current.toLocaleString('default', { month: 'short' });
                const year = current.getFullYear();
                const monthStart = new Date(current);
                const monthEnd = new Date(current.getFullYear(), current.getMonth() + 1, 0);
                const displayEnd = monthEnd > endDate ? endDate : monthEnd;

                let daysHtml = '';
                let dayCount = 0;

                for (let d = new Date(monthStart); d <= displayEnd; d.setDate(d.getDate() + 1)) {
                    const dayNum = d.getDate();
                    const dayOfWeek = d.getDay();
                    const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                    const isToday = d.toDateString() === today.toDateString();

                    let classes = 'timeline-day';
                    if (isWeekend) classes += ' weekend';
                    if (isToday) classes += ' today';

                    daysHtml += `<div class="${classes}">${dayNum}</div>`;
                    dayCount++;
                }

                html += `
                    <div class="timeline-month" style="width: ${dayCount * dayWidth}px">
                        <div class="timeline-month-name">${month} ${year}</div>
                        <div class="timeline-days">${daysHtml}</div>
                    </div>
                `;
                current = new Date(current.getFullYear(), current.getMonth() + 1, 1);
            }
            header.innerHTML = html;
        }

        function renderTaskList() {
            const list = document.getElementById('taskList');
            let html = '';

            tasks.forEach(task => {
                const isGroup = task.type === 'group';
                const isMilestone = task.type === 'milestone';

                html += `
                    <div class="task-row ${isGroup ? 'group' : ''}" data-id="${task.id}">
                        <span class="task-icon">
                            ${isGroup ? '<i class="bi bi-folder"></i>' :
                              isMilestone ? '<i class="bi bi-diamond-fill"></i>' :
                              '<i class="bi bi-check2-square"></i>'}
                        </span>
                        <span class="task-name">${task.name}</span>
                        <div class="task-actions">
                            <button class="btn btn-outline-secondary btn-sm" onclick="openTaskModal(${task.id})"><i class="bi bi-pencil"></i></button>
                        </div>
                        ${task.assignee ? `<span class="task-assignee">${task.assignee}</span>` : '<span style="width:28px"></span>'}
                    </div>
                `;
            });
            list.innerHTML = html;
        }

        function renderTimelineBody() {
            const body = document.getElementById('timelineBody');
            const totalDays = daysBetween(startDate, endDate) + 1;

            // Clear existing content except SVG
            const svg = document.getElementById('dependenciesLayer');
            body.innerHTML = '';
            body.appendChild(svg);

            // Render rows
            tasks.forEach((task, index) => {
                const isGroup = task.type === 'group';
                const row = document.createElement('div');
                row.className = `timeline-row ${isGroup ? 'group' : ''}`;
                row.dataset.id = task.id;

                let cellsHtml = '';
                for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                    const dayOfWeek = d.getDay();
                    const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                    const isToday = d.toDateString() === today.toDateString();

                    let classes = 'timeline-cell';
                    if (isWeekend) classes += ' weekend';
                    if (isToday) classes += ' today';
                    cellsHtml += `<div class="${classes}"></div>`;
                }
                row.innerHTML = cellsHtml;
                body.appendChild(row);
            });

            body.style.width = `${totalDays * dayWidth}px`;

            // Render bars
            tasks.forEach((task, index) => {
                const taskStart = parseDate(task.start);
                const taskEnd = parseDate(task.end);
                const startOffset = daysBetween(startDate, taskStart) * dayWidth;
                const duration = daysBetween(taskStart, taskEnd) + 1;
                const width = duration * dayWidth - 4;
                const top = index * rowHeight;

                if (task.type === 'milestone') {
                    const el = document.createElement('div');
                    el.className = 'milestone';
                    el.style.left = `${startOffset + (dayWidth/2) - 10}px`;
                    el.style.top = `${top + 12}px`;
                    el.dataset.id = task.id;
                    el.ondblclick = () => openTaskModal(task.id);
                    body.appendChild(el);
                } else if (task.type === 'group') {
                    const bar = document.createElement('div');
                    bar.className = 'gantt-bar group-bar';
                    bar.style.left = `${startOffset + 2}px`;
                    bar.style.width = `${width}px`;
                    bar.style.top = `${top + 18}px`;
                    bar.dataset.id = task.id;
                    body.appendChild(bar);
                } else {
                    const bar = document.createElement('div');
                    bar.className = `gantt-bar ${task.color || 'blue'}`;
                    bar.style.left = `${startOffset + 2}px`;
                    bar.style.width = `${width}px`;
                    bar.style.top = `${top + 10}px`;
                    bar.dataset.id = task.id;

                    let innerHTML = '';
                    if (task.progress > 0) {
                        innerHTML += `<div class="progress-fill" style="width: ${task.progress}%"></div>`;
                    }
                    innerHTML += `<span class="bar-label">${task.name}</span>`;
                    innerHTML += `<div class="resize-handle left"></div>`;
                    innerHTML += `<div class="resize-handle right"></div>`;
                    bar.innerHTML = innerHTML;

                    // Drag & resize
                    setupDragAndResize(bar, task);
                    bar.ondblclick = () => openTaskModal(task.id);
                    body.appendChild(bar);
                }
            });

            // Today line
            const todayOffset = daysBetween(startDate, today) * dayWidth + (dayWidth / 2);
            if (todayOffset >= 0 && todayOffset <= totalDays * dayWidth) {
                const todayLine = document.createElement('div');
                todayLine.className = 'today-line';
                todayLine.style.left = `${todayOffset}px`;
                todayLine.style.height = `${tasks.length * rowHeight}px`;
                body.appendChild(todayLine);
            }

            document.getElementById('timelineWrapper').style.width = `${totalDays * dayWidth}px`;

            // Render dependencies
            renderDependencies();
        }

        function renderDependencies() {
            const svg = document.getElementById('dependenciesLayer');
            const totalDays = daysBetween(startDate, endDate) + 1;
            svg.setAttribute('width', totalDays * dayWidth);
            svg.setAttribute('height', tasks.length * rowHeight);

            // Remove old paths
            svg.querySelectorAll('path').forEach(p => p.remove());

            tasks.forEach((task, index) => {
                if (!task.dependsOn) return;

                const depIndex = tasks.findIndex(t => t.id === task.dependsOn);
                if (depIndex === -1) return;

                const depTask = tasks[depIndex];
                const depEnd = parseDate(depTask.end);
                const taskStart = parseDate(task.start);

                const x1 = daysBetween(startDate, depEnd) * dayWidth + dayWidth;
                const y1 = depIndex * rowHeight + rowHeight / 2;
                const x2 = daysBetween(startDate, taskStart) * dayWidth;
                const y2 = index * rowHeight + rowHeight / 2;

                const midX = (x1 + x2) / 2;
                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                path.setAttribute('class', 'dependency-line');
                path.setAttribute('d', `M ${x1} ${y1} C ${midX} ${y1}, ${midX} ${y2}, ${x2} ${y2}`);
                svg.appendChild(path);
            });
        }

        // Drag and resize
        function setupDragAndResize(bar, task) {
            let isDragging = false;
            let isResizing = false;
            let resizeDir = null;
            let startX = 0;
            let origLeft = 0;
            let origWidth = 0;

            bar.addEventListener('mousedown', (e) => {
                if (e.target.classList.contains('resize-handle')) {
                    isResizing = true;
                    resizeDir = e.target.classList.contains('left') ? 'left' : 'right';
                } else {
                    isDragging = true;
                }
                bar.classList.add('dragging');
                startX = e.clientX;
                origLeft = parseInt(bar.style.left);
                origWidth = parseInt(bar.style.width);
                e.preventDefault();
            });

            document.addEventListener('mousemove', (e) => {
                if (!isDragging && !isResizing) return;

                const dx = e.clientX - startX;
                const daysDelta = Math.round(dx / dayWidth);

                if (isDragging) {
                    bar.style.left = `${origLeft + daysDelta * dayWidth}px`;
                } else if (isResizing) {
                    if (resizeDir === 'right') {
                        const newWidth = origWidth + daysDelta * dayWidth;
                        if (newWidth >= dayWidth) {
                            bar.style.width = `${newWidth}px`;
                        }
                    } else {
                        const newWidth = origWidth - daysDelta * dayWidth;
                        if (newWidth >= dayWidth) {
                            bar.style.left = `${origLeft + daysDelta * dayWidth}px`;
                            bar.style.width = `${newWidth}px`;
                        }
                    }
                }
            });

            document.addEventListener('mouseup', () => {
                if (!isDragging && !isResizing) return;

                bar.classList.remove('dragging');

                // Calculate new dates
                const newLeft = parseInt(bar.style.left) - 2;
                const newWidth = parseInt(bar.style.width) + 4;
                const startDays = Math.round(newLeft / dayWidth);
                const durationDays = Math.round(newWidth / dayWidth);

                const newStart = new Date(startDate);
                newStart.setDate(newStart.getDate() + startDays);
                const newEnd = new Date(newStart);
                newEnd.setDate(newEnd.getDate() + durationDays - 1);

                task.start = formatDate(newStart);
                task.end = formatDate(newEnd);
                saveToStorage();

                isDragging = false;
                isResizing = false;
                resizeDir = null;

                renderDependencies();
            });
        }

        // Task Modal
        function openTaskModal(id = null) {
            const modal = new bootstrap.Modal(document.getElementById('taskModal'));
            const isEdit = id !== null;

            document.getElementById('taskModalTitle').textContent = isEdit ? 'Edit Task' : 'Add Task';
            document.getElementById('deleteTaskBtn').style.display = isEdit ? 'block' : 'none';

            // Populate dependency dropdown
            const depSelect = document.getElementById('taskDependency');
            depSelect.innerHTML = '<option value="">None</option>';
            tasks.forEach(t => {
                if (t.id !== id && t.type !== 'group') {
                    depSelect.innerHTML += `<option value="${t.id}">${t.name}</option>`;
                }
            });

            if (isEdit) {
                const task = tasks.find(t => t.id === id);
                document.getElementById('taskId').value = id;
                document.getElementById('taskName').value = task.name;
                document.getElementById('taskType').value = task.type || 'task';
                document.getElementById('taskStart').value = task.start;
                document.getElementById('taskEnd').value = task.end;
                document.getElementById('taskAssignee').value = task.assignee || '';
                document.getElementById('taskProgress').value = task.progress || 0;
                document.getElementById('progressValue').textContent = task.progress || 0;
                document.getElementById('taskDependency').value = task.dependsOn || '';

                // Set color
                document.querySelectorAll('.color-option').forEach(el => {
                    el.classList.toggle('selected', el.dataset.color === (task.color || 'blue'));
                });
            } else {
                document.getElementById('taskId').value = '';
                document.getElementById('taskName').value = '';
                document.getElementById('taskType').value = 'task';
                document.getElementById('taskStart').value = formatDate(today);
                const nextWeek = new Date(today);
                nextWeek.setDate(nextWeek.getDate() + 7);
                document.getElementById('taskEnd').value = formatDate(nextWeek);
                document.getElementById('taskAssignee').value = '';
                document.getElementById('taskProgress').value = 0;
                document.getElementById('progressValue').textContent = 0;
                document.getElementById('taskDependency').value = '';
                document.querySelectorAll('.color-option').forEach(el => {
                    el.classList.toggle('selected', el.dataset.color === 'blue');
                });
            }

            toggleTaskFields();
            modal.show();
        }

        function toggleTaskFields() {
            const type = document.getElementById('taskType').value;
            const taskFields = document.getElementById('taskFields');
            const endDateCol = document.getElementById('endDateCol');

            taskFields.style.display = type === 'task' ? 'block' : 'none';
            endDateCol.style.display = type === 'milestone' ? 'none' : 'block';

            if (type === 'milestone') {
                document.getElementById('taskEnd').value = document.getElementById('taskStart').value;
            }
        }

        function saveTask() {
            const id = document.getElementById('taskId').value;
            const name = document.getElementById('taskName').value.trim();
            const type = document.getElementById('taskType').value;
            const start = document.getElementById('taskStart').value;
            let end = document.getElementById('taskEnd').value;

            if (!name || !start) {
                showToast('Please fill in required fields');
                return;
            }

            if (type === 'milestone') end = start;

            const taskData = {
                id: id ? parseInt(id) : Date.now(),
                name,
                type: type === 'task' ? undefined : type,
                start,
                end,
            };

            if (type === 'task') {
                taskData.assignee = document.getElementById('taskAssignee').value.trim() || undefined;
                taskData.progress = parseInt(document.getElementById('taskProgress').value);
                taskData.color = document.querySelector('.color-option.selected')?.dataset.color || 'blue';
                const dep = document.getElementById('taskDependency').value;
                if (dep) taskData.dependsOn = parseInt(dep);
            }

            if (id) {
                const index = tasks.findIndex(t => t.id === parseInt(id));
                tasks[index] = taskData;
            } else {
                tasks.push(taskData);
            }

            saveToStorage();
            bootstrap.Modal.getInstance(document.getElementById('taskModal')).hide();
            render();
            showToast(id ? 'Task updated' : 'Task created');
        }

        function deleteTask() {
            const id = parseInt(document.getElementById('taskId').value);
            if (confirm('Delete this task?')) {
                tasks = tasks.filter(t => t.id !== id);
                // Remove dependencies to this task
                tasks.forEach(t => {
                    if (t.dependsOn === id) delete t.dependsOn;
                });
                saveToStorage();
                bootstrap.Modal.getInstance(document.getElementById('taskModal')).hide();
                render();
                showToast('Task deleted');
            }
        }

        // Color picker
        document.getElementById('colorPicker').addEventListener('click', (e) => {
            if (e.target.classList.contains('color-option')) {
                document.querySelectorAll('.color-option').forEach(el => el.classList.remove('selected'));
                e.target.classList.add('selected');
            }
        });

        // Scroll to today
        function scrollToToday() {
            const timelineArea = document.getElementById('timelineArea');
            const todayOffset = daysBetween(startDate, today) * dayWidth - timelineArea.clientWidth / 2;
            timelineArea.scrollLeft = Math.max(0, todayOffset);
        }

        // Sync scroll
        function setupScrollSync() {
            const taskList = document.getElementById('taskList');
            const timelineArea = document.getElementById('timelineArea');

            taskList.addEventListener('scroll', () => {
                timelineArea.scrollTop = taskList.scrollTop;
            });

            timelineArea.addEventListener('scroll', () => {
                taskList.scrollTop = timelineArea.scrollTop;
            });
        }

        // Main render
        function render() {
            calculateDateRange();
            renderTimelineHeader();
            renderTaskList();
            renderTimelineBody();
        }

        // Color map for SVG export
        const colorMap = {
            blue: { start: '#3b82f6', end: '#2563eb' },
            green: { start: '#22c55e', end: '#16a34a' },
            purple: { start: '#8b5cf6', end: '#7c3aed' },
            orange: { start: '#f97316', end: '#ea580c' },
            pink: { start: '#ec4899', end: '#db2777' },
            teal: { start: '#14b8a6', end: '#0d9488' }
        };

        // Generate SVG content
        function generateSVG() {
            const totalDays = daysBetween(startDate, endDate) + 1;
            const sidebarWidth = 300;
            const headerHeight = 50;
            const width = sidebarWidth + totalDays * dayWidth;
            const height = headerHeight + tasks.length * rowHeight;

            let svg = `<svg xmlns="http://www.w3.org/2000/svg" width="${width}" height="${height}" viewBox="0 0 ${width} ${height}">`;

            // Defs for gradients and markers
            svg += `<defs>`;
            Object.entries(colorMap).forEach(([name, colors]) => {
                svg += `<linearGradient id="grad-${name}" x1="0%" y1="0%" x2="100%" y2="100%">
                    <stop offset="0%" style="stop-color:${colors.start}"/>
                    <stop offset="100%" style="stop-color:${colors.end}"/>
                </linearGradient>`;
            });
            svg += `<marker id="arrow" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                <polygon points="0 0, 10 3.5, 0 7" fill="#94a3b8"/>
            </marker>`;
            svg += `</defs>`;

            // Background
            svg += `<rect width="${width}" height="${height}" fill="#f8fafc"/>`;

            // Sidebar background
            svg += `<rect x="0" y="0" width="${sidebarWidth}" height="${height}" fill="white"/>`;
            svg += `<rect x="0" y="0" width="${sidebarWidth}" height="${headerHeight}" fill="white"/>`;
            svg += `<line x1="${sidebarWidth}" y1="0" x2="${sidebarWidth}" y2="${height}" stroke="#e2e8f0" stroke-width="2"/>`;

            // Sidebar header
            svg += `<text x="16" y="30" font-family="Arial, sans-serif" font-size="11" font-weight="600" fill="#64748b">TASK NAME</text>`;

            // Timeline header background
            svg += `<rect x="${sidebarWidth}" y="0" width="${totalDays * dayWidth}" height="${headerHeight}" fill="white"/>`;
            svg += `<line x1="${sidebarWidth}" y1="${headerHeight}" x2="${width}" y2="${headerHeight}" stroke="#e2e8f0"/>`;

            // Draw timeline columns (weekends, today)
            let dayIndex = 0;
            for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                const x = sidebarWidth + dayIndex * dayWidth;
                const dayOfWeek = d.getDay();
                const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                const isToday = d.toDateString() === today.toDateString();

                if (isWeekend) {
                    svg += `<rect x="${x}" y="0" width="${dayWidth}" height="${height}" fill="#fafafa"/>`;
                }
                if (isToday) {
                    svg += `<rect x="${x}" y="0" width="${dayWidth}" height="${height}" fill="#eef2ff"/>`;
                }
                dayIndex++;
            }

            // Draw month headers and day numbers
            let current = new Date(startDate);
            let xOffset = sidebarWidth;
            while (current <= endDate) {
                const month = current.toLocaleString('default', { month: 'short' });
                const year = current.getFullYear();
                const monthStart = new Date(current);
                const monthEnd = new Date(current.getFullYear(), current.getMonth() + 1, 0);
                const displayEnd = monthEnd > endDate ? endDate : monthEnd;

                let dayCount = 0;
                for (let d = new Date(monthStart); d <= displayEnd; d.setDate(d.getDate() + 1)) {
                    const dayNum = d.getDate();
                    const dayX = xOffset + dayCount * dayWidth;
                    svg += `<text x="${dayX + dayWidth/2}" y="${headerHeight - 8}" font-family="Arial, sans-serif" font-size="10" fill="#94a3b8" text-anchor="middle">${dayNum}</text>`;
                    dayCount++;
                }

                const monthWidth = dayCount * dayWidth;
                svg += `<text x="${xOffset + monthWidth/2}" y="18" font-family="Arial, sans-serif" font-size="11" font-weight="600" fill="#64748b" text-anchor="middle">${month} ${year}</text>`;
                svg += `<line x1="${xOffset + monthWidth}" y1="0" x2="${xOffset + monthWidth}" y2="${headerHeight}" stroke="#e2e8f0"/>`;

                xOffset += monthWidth;
                current = new Date(current.getFullYear(), current.getMonth() + 1, 1);
            }

            // Draw horizontal row lines
            for (let i = 0; i <= tasks.length; i++) {
                const y = headerHeight + i * rowHeight;
                svg += `<line x1="0" y1="${y}" x2="${width}" y2="${y}" stroke="#f1f5f9"/>`;
            }

            // Helper to escape XML special characters
            function escapeXml(str) {
                return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
            }

            // Draw task rows
            tasks.forEach((task, index) => {
                const y = headerHeight + index * rowHeight;
                const isGroup = task.type === 'group';
                const isMilestone = task.type === 'milestone';

                // Row background for groups
                if (isGroup) {
                    svg += `<rect x="0" y="${y}" width="${sidebarWidth}" height="${rowHeight}" fill="#f1f5f9"/>`;
                    svg += `<rect x="${sidebarWidth}" y="${y}" width="${totalDays * dayWidth}" height="${rowHeight}" fill="#f8fafc"/>`;
                }

                // Draw icon as SVG shape instead of emoji
                const iconX = 16;
                const iconY = y + rowHeight/2;
                if (isGroup) {
                    // Folder icon
                    svg += `<rect x="${iconX}" y="${iconY - 5}" width="12" height="10" fill="#94a3b8" rx="1"/>`;
                    svg += `<rect x="${iconX}" y="${iconY - 7}" width="6" height="3" fill="#94a3b8" rx="1"/>`;
                } else if (isMilestone) {
                    // Diamond icon
                    svg += `<rect x="${iconX + 3}" y="${iconY - 5}" width="8" height="8" fill="#f97316" transform="rotate(45 ${iconX + 7} ${iconY - 1})"/>`;
                } else {
                    // Checkbox icon
                    svg += `<rect x="${iconX}" y="${iconY - 6}" width="12" height="12" fill="none" stroke="#94a3b8" stroke-width="1.5" rx="2"/>`;
                }

                // Task name in sidebar (escaped)
                const taskName = escapeXml(task.name);
                svg += `<text x="34" y="${y + rowHeight/2 + 4}" font-family="Arial, sans-serif" font-size="12" fill="#1e293b" ${isGroup ? 'font-weight="600"' : ''}>${taskName}</text>`;

                // Assignee
                if (task.assignee) {
                    svg += `<circle cx="${sidebarWidth - 24}" cy="${y + rowHeight/2}" r="12" fill="#818cf8"/>`;
                    svg += `<text x="${sidebarWidth - 24}" y="${y + rowHeight/2 + 4}" font-family="Arial, sans-serif" font-size="9" fill="white" text-anchor="middle" font-weight="600">${escapeXml(task.assignee)}</text>`;
                }
            });

            // Draw dependencies
            tasks.forEach((task, index) => {
                if (!task.dependsOn) return;
                const depIndex = tasks.findIndex(t => t.id === task.dependsOn);
                if (depIndex === -1) return;

                const depTask = tasks[depIndex];
                const depEnd = parseDate(depTask.end);
                const taskStart = parseDate(task.start);

                const x1 = sidebarWidth + daysBetween(startDate, depEnd) * dayWidth + dayWidth;
                const y1 = headerHeight + depIndex * rowHeight + rowHeight / 2;
                const x2 = sidebarWidth + daysBetween(startDate, taskStart) * dayWidth;
                const y2 = headerHeight + index * rowHeight + rowHeight / 2;

                const midX = (x1 + x2) / 2;
                svg += `<path d="M ${x1} ${y1} C ${midX} ${y1}, ${midX} ${y2}, ${x2} ${y2}" fill="none" stroke="#94a3b8" stroke-width="2" marker-end="url(#arrow)"/>`;
            });

            // Draw bars
            tasks.forEach((task, index) => {
                const taskStart = parseDate(task.start);
                const taskEnd = parseDate(task.end);
                const startOffset = daysBetween(startDate, taskStart) * dayWidth;
                const duration = daysBetween(taskStart, taskEnd) + 1;
                const barWidth = duration * dayWidth - 4;
                const x = sidebarWidth + startOffset + 2;
                const y = headerHeight + index * rowHeight;

                if (task.type === 'milestone') {
                    const mx = sidebarWidth + startOffset + dayWidth/2;
                    const my = y + rowHeight/2;
                    svg += `<rect x="${mx - 10}" y="${my - 10}" width="14" height="14" fill="#f97316" transform="rotate(45 ${mx} ${my})" rx="2"/>`;
                } else if (task.type === 'group') {
                    svg += `<rect x="${x}" y="${y + 18}" width="${barWidth}" height="8" fill="#475569" rx="2"/>`;
                    svg += `<polygon points="${x},${y + 26} ${x + 4},${y + 26} ${x + 2},${y + 30}" fill="#475569"/>`;
                    svg += `<polygon points="${x + barWidth},${y + 26} ${x + barWidth - 4},${y + 26} ${x + barWidth - 2},${y + 30}" fill="#475569"/>`;
                } else {
                    const color = task.color || 'blue';
                    svg += `<rect x="${x}" y="${y + 10}" width="${barWidth}" height="24" fill="url(#grad-${color})" rx="4"/>`;
                    if (task.progress > 0) {
                        svg += `<rect x="${x}" y="${y + 10}" width="${barWidth * task.progress / 100}" height="24" fill="rgba(255,255,255,0.25)" rx="4"/>`;
                    }
                    svg += `<text x="${x + 8}" y="${y + 26}" font-family="Arial, sans-serif" font-size="11" fill="white" font-weight="500">${escapeXml(task.name)}</text>`;
                }
            });

            // Today line
            const todayOffset = daysBetween(startDate, today) * dayWidth + dayWidth / 2;
            if (todayOffset >= 0 && todayOffset <= totalDays * dayWidth) {
                const tx = sidebarWidth + todayOffset;
                svg += `<line x1="${tx}" y1="${headerHeight}" x2="${tx}" y2="${height}" stroke="#ef4444" stroke-width="2"/>`;
                svg += `<text x="${tx}" y="${headerHeight - 5}" font-family="Arial, sans-serif" font-size="9" fill="#ef4444" text-anchor="middle" font-weight="600">Today</text>`;
            }

            svg += `</svg>`;
            return svg;
        }

        // Export as SVG
        function exportAsSVG() {
            const svg = generateSVG();
            const blob = new Blob([svg], { type: 'image/svg+xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'gantt-chart.svg';
            a.click();
            URL.revokeObjectURL(url);
            showToast('SVG exported successfully!');
        }

        // Export as PNG
        function exportAsPNG() {
            showToast('Generating PNG...');
            const svg = generateSVG();

            // Parse SVG to get dimensions
            const parser = new DOMParser();
            const svgDoc = parser.parseFromString(svg, 'image/svg+xml');
            const svgEl = svgDoc.documentElement;
            const width = parseInt(svgEl.getAttribute('width'));
            const height = parseInt(svgEl.getAttribute('height'));

            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const scale = 2; // 2x for better quality

            canvas.width = width * scale;
            canvas.height = height * scale;
            ctx.scale(scale, scale);

            // Fill background
            ctx.fillStyle = '#f8fafc';
            ctx.fillRect(0, 0, width, height);

            const img = new Image();

            img.onload = () => {
                ctx.drawImage(img, 0, 0, width, height);

                // Convert to PNG and download
                const pngUrl = canvas.toDataURL('image/png');
                const a = document.createElement('a');
                a.href = pngUrl;
                a.download = 'gantt-chart.png';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                showToast('PNG exported successfully!');
            };

            img.onerror = (e) => {
                console.error('PNG export error:', e);
                showToast('Error generating PNG - try SVG instead');
            };

            // Use base64 data URL instead of blob URL for better compatibility
            const svgBase64 = btoa(unescape(encodeURIComponent(svg)));
            img.src = 'data:image/svg+xml;base64,' + svgBase64;
        }

        // Initialize
        loadFromStorage();
        render();
        setupScrollSync();
        setTimeout(scrollToToday, 100);
    </script>
</body>
</html>
